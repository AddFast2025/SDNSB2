<script>
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw5axaPMrVkcqn92VMDRSuJl1LwRBCibU3DkMtu40jrYqGfRiNAomQhfcl0g3qPUl2OKg/exec";
  
  const scanBtn = document.getElementById("scanBtn");
  const output = document.getElementById("output");
  const readerDiv = document.getElementById("reader");

  // fungsi suara
  function beep(success = true) {
    const ctx = new AudioContext();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    if (success) {
      osc.frequency.value = 800;
      gain.gain.setValueAtTime(0.2, ctx.currentTime);
      osc.start();
      osc.stop(ctx.currentTime + 0.2);
    } else {
      osc.frequency.value = 400;
      gain.gain.setValueAtTime(0.2, ctx.currentTime);
      osc.start();
      osc.stop(ctx.currentTime + 0.5);
    }
  }

  scanBtn.addEventListener("click", () => {
    startScan();
  });

  function startScan() {
    const html5QrCode = new Html5Qrcode("reader"); // bikin ulang tiap kali klik

    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      (decodedText) => {
        html5QrCode.stop().then(() => {
          html5QrCode.clear();

          if (decodedText.charAt(0) === "|") {
            beep(true);
            output.textContent = "âœ… Berhasil: " + decodedText;

            // kirim ke Google Sheets
            fetch(WEB_APP_URL, {
              method: "POST",
              body: JSON.stringify({ qr: decodedText })
            });
          } else {
            beep(false);
            output.textContent = "âŒ Silakan scan kartu QR siswa";
          }
        });
      },
      (error) => { /* abaikan error */ }
    );
  }
</script>
